name: CD Pipeline - Azure Progressive Canary Deployment (Simplified)

on:
  push:
    branches: [main, master]
  workflow_dispatch:
    inputs:
      deployment-speed:
        description: 'Deployment Speed'
        required: true
        default: 'standard'
        type: choice
        options:
        - rapid
        - standard
        - cautious

env:
  IMAGE_NAME: bp-calculator
  ACR_NAME: 'bpcalculator2024'           # Your actual ACR name
  RESOURCE_GROUP: 'bp-calculator-rg'     # Your resource group
  LOCATION: 'eastus'                     # Your region
  
  # Canary Traffic Progression
  CANARY_PHASE_1: 5    # Initial canary traffic percentage
  CANARY_PHASE_2: 25   # Second phase traffic percentage
  CANARY_PHASE_3: 75   # Third phase traffic percentage

permissions:
  id-token: write
  contents: read

jobs:
  # =====================
  # PHASE 1: CODE BUILD & VALIDATION
  # =====================
  build-validation:
    runs-on: ubuntu-latest
    outputs:
      docker-tag: ${{ steps.version.outputs.docker-tag }}
      image-uri: ${{ steps.build-image.outputs.image-uri }}
    steps:
      - name: Checkout Source Code
        uses: actions/checkout@v4

      - name: Setup .NET Environment
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: '9.0.x'

      - name: Generate Deployment Version
        id: version
        run: |
          SHORT_SHA=${GITHUB_SHA::8}
          TAG="canary-$(date +%Y%m%d)-${SHORT_SHA}"
          echo "docker-tag=$TAG" >> $GITHUB_OUTPUT
          echo "Deployment Tag: $TAG"

      - name: Restore Dependencies
        run: dotnet restore ./bp-calculator.sln

      - name: Compile Application
        run: dotnet build ./bp-calculator.sln --configuration Release --no-restore

      - name: Execute Test Suite
        run: dotnet test ./BP.Tests/BP.Tests.csproj --configuration Release --no-build --verbosity normal

      - name: Login to Azure Container Registry
        uses: azure/docker-login@v1
        with:
          login-server: ${{ env.ACR_NAME }}.azurecr.io
          username: ${{ secrets.ACR_USERNAME }}
          password: ${{ secrets.ACR_PASSWORD }}

      - name: Build and Push Docker Image to ACR
        id: build-image
        run: |
          # Build image with the new tag
          docker build -t ${{ env.ACR_NAME }}.azurecr.io/${{ env.IMAGE_NAME }}:${{ steps.version.outputs.docker-tag }} .
          
          # Also tag as latest for consistency
          docker tag ${{ env.ACR_NAME }}.azurecr.io/${{ env.IMAGE_NAME }}:${{ steps.version.outputs.docker-tag }} \
            ${{ env.ACR_NAME }}.azurecr.io/${{ env.IMAGE_NAME }}:latest
          
          # Push both tags to ACR
          docker push ${{ env.ACR_NAME }}.azurecr.io/${{ env.IMAGE_NAME }}:${{ steps.version.outputs.docker-tag }}
          docker push ${{ env.ACR_NAME }}.azurecr.io/${{ env.IMAGE_NAME }}:latest
          
          # Set output for use in later jobs
          echo "image-uri=${{ env.ACR_NAME }}.azurecr.io/${{ env.IMAGE_NAME }}:${{ steps.version.outputs.docker-tag }}" >> $GITHUB_OUTPUT

  # =====================
  # PHASE 2: AZURE DEPLOYMENT WITH SIMPLIFIED CANARY
  # =====================
  azure-canary-deployment:
    runs-on: ubuntu-latest
    needs: build-validation
    environment: production
    steps:
      - name: Azure Login
        uses: azure/login@v2
        with:
          client-id: ${{ secrets.AZURE_CLIENT_ID }}
          tenant-id: ${{ secrets.AZURE_TENANT_ID }}
          subscription-id: ${{ secrets.AZURE_SUBSCRIPTION_ID }}

      - name: Check for Existing Production Container
        id: check-existing
        run: |
          # Check if production container already exists
          if az container show --resource-group ${{ env.RESOURCE_GROUP }} --name bp-production 2>/dev/null; then
            echo "EXISTING_PRODUCTION=true" >> $GITHUB_OUTPUT
            PROD_IP=$(az container show --resource-group ${{ env.RESOURCE_GROUP }} --name bp-production --query "ipAddress.ip" -o tsv)
            echo "EXISTING_IP=$PROD_IP" >> $GITHUB_OUTPUT
          else
            echo "EXISTING_PRODUCTION=false" >> $GITHUB_OUTPUT
          fi

      # =====================
      # CANARY PHASE 1: Deploy canary alongside existing production (5%)
      # =====================
      - name: Deploy Canary Phase 1 (5% Simulation)
        id: deploy-canary-phase1
        run: |
          echo "üöÄ CANARY PHASE 1: Deploying canary version"
          echo "Traffic Simulation: ${{ env.CANARY_PHASE_1 }}% to canary"
          
          # Deploy canary container instance
          az container create \
            --resource-group ${{ env.RESOURCE_GROUP }} \
            --name bp-canary-phase1 \
            --image ${{ env.ACR_NAME }}.azurecr.io/${{ env.IMAGE_NAME }}:latest \
            --cpu 1 \
            --memory 1.5 \
            --ports 8080 \
            --dns-name-label bp-canary-phase1-${{ github.run_id }} \
            --environment-variables ASPNETCORE_ENVIRONMENT=Production CANARY_PHASE=1 \
            --restart-policy Always \
            --location ${{ env.LOCATION }} \
            --registry-username ${{ secrets.ACR_USERNAME }} \
            --registry-password ${{ secrets.ACR_PASSWORD }} \
            --os-type Linux
          
          # Get canary IP address
          CANARY_IP=$(az container show \
            --resource-group ${{ env.RESOURCE_GROUP }} \
            --name bp-canary-phase1 \
            --query "ipAddress.ip" -o tsv)
          echo "CANARY_IP=$CANARY_IP" >> $GITHUB_OUTPUT
          echo "Canary deployed at: $CANARY_IP:8080"

      - name: Verify Canary Phase 1 Health
        run: |
          echo "Verifying canary health..."
          CANARY_IP=${{ steps.deploy-canary-phase1.outputs.CANARY_IP }}
          
          for i in {1..15}; do
            if curl -s -f http://$CANARY_IP:8080/health > /dev/null; then
              echo "‚úÖ Canary Phase 1 is healthy!"
              break
            fi
            echo "‚è≥ Waiting for canary... Attempt $i/15"
            sleep 4
          done
          
          # Test business logic
          echo "Testing canary functionality..."
          curl -X POST http://$CANARY_IP:8080/api/bp/calculate \
            -H "Content-Type: application/json" \
            -d '{"Systolic":120,"Diastolic":80}' && echo "‚úÖ Canary functionality verified"

      - name: Monitor Canary Phase 1 (5% Traffic Simulation)
        run: |
          echo "üìä Monitoring Canary Phase 1 (${{ env.CANARY_PHASE_1 }}% traffic simulation)"
          echo "Duration: 120 seconds"
          
          CANARY_IP=${{ steps.deploy-canary-phase1.outputs.CANARY_IP }}
          
          # Simulate 5% of traffic going to canary (1 in 20 requests)
          for i in {1..12}; do
            echo "Interval $i/12 (10 seconds each)..."
            
            # Simulate traffic pattern: 5% to canary, 95% to production (if exists)
            for j in {1..19}; do
              if [ "${{ steps.check-existing.outputs.EXISTING_PRODUCTION }}" = "true" ]; then
                curl -s http://${{ steps.check-existing.outputs.EXISTING_IP }}:8080/health > /dev/null || true
              fi
            done
            
            # 5% request to canary
            curl -s http://$CANARY_IP:8080/health > /dev/null && echo "  Canary request successful" || true
            
            sleep 10
          done

      # =====================
      # CANARY PHASE 2: Increase to 25% traffic
      # =====================
      - name: Deploy Canary Phase 2 (25% Simulation)
        id: deploy-canary-phase2
        run: |
          echo "üìà CANARY PHASE 2: Scaling canary presence"
          echo "Traffic Simulation: ${{ env.CANARY_PHASE_2 }}% to canary"
          
          # Deploy second canary instance for increased capacity
          az container create \
            --resource-group ${{ env.RESOURCE_GROUP }} \
            --name bp-canary-phase2 \
            --image ${{ env.ACR_NAME }}.azurecr.io/${{ env.IMAGE_NAME }}:latest \
            --cpu 1 \
            --memory 1.5 \
            --ports 8080 \
            --dns-name-label bp-canary-phase2-${{ github.run_id }} \
            --environment-variables ASPNETCORE_ENVIRONMENT=Production CANARY_PHASE=2 \
            --restart-policy Always \
            --location ${{ env.LOCATION }} \
            --registry-username ${{ secrets.ACR_USERNAME }} \
            --registry-password ${{ secrets.ACR_PASSWORD }} \
            --os-type Linux
          
          # Get second canary IP
          CANARY2_IP=$(az container show \
            --resource-group ${{ env.RESOURCE_GROUP }} \
            --name bp-canary-phase2 \
            --query "ipAddress.ip" -o tsv)
          echo "CANARY2_IP=$CANARY2_IP" >> $GITHUB_OUTPUT

      - name: Monitor Canary Phase 2 (25% Traffic Simulation)
        run: |
          echo "üìä Monitoring Canary Phase 2 (${{ env.CANARY_PHASE_2 }}% traffic simulation)"
          echo "Duration: 180 seconds"
          
          CANARY1_IP=${{ steps.deploy-canary-phase1.outputs.CANARY_IP }}
          CANARY2_IP=${{ steps.deploy-canary-phase2.outputs.CANARY2_IP }}
          
          # Simulate 25% traffic to canary instances
          for i in {1..18}; do
            echo "Interval $i/18 (10 seconds each)..."
            
            # Traffic pattern: 25% to canaries (split between two instances), 75% to production
            for j in {1..3}; do
              if [ "${{ steps.check-existing.outputs.EXISTING_PRODUCTION }}" = "true" ]; then
                curl -s http://${{ steps.check-existing.outputs.EXISTING_IP }}:8080/health > /dev/null || true
              fi
            done
            
            # 25% to canaries
            curl -s http://$CANARY1_IP:8080/health > /dev/null || true
            curl -s http://$CANARY2_IP:8080/health > /dev/null || true
            
            # Test business logic every 3rd interval
            if [ $((i % 3)) -eq 0 ]; then
              echo "  üß™ Testing canary functionality..."
              curl -s -X POST http://$CANARY1_IP:8080/api/bp/calculate \
                -H "Content-Type: application/json" \
                -d '{"Systolic":130,"Diastolic":85}' > /dev/null && echo "    Canary 1 OK" || true
            fi
            
            sleep 10
          done

      # =====================
      # CANARY PHASE 3: Increase to 75% traffic
      # =====================
      - name: Deploy Canary Phase 3 (75% Simulation)
        id: deploy-canary-phase3
        run: |
          echo "üî• CANARY PHASE 3: Majority traffic shift"
          echo "Traffic Simulation: ${{ env.CANARY_PHASE_3 }}% to canary"
          
          # Deploy third canary instance
          az container create \
            --resource-group ${{ env.RESOURCE_GROUP }} \
            --name bp-canary-phase3 \
            --image ${{ env.ACR_NAME }}.azurecr.io/${{ env.IMAGE_NAME }}:latest \
            --cpu 1 \
            --memory 1.5 \
            --ports 8080 \
            --dns-name-label bp-canary-phase3-${{ github.run_id }} \
            --environment-variables ASPNETCORE_ENVIRONMENT=Production CANARY_PHASE=3 \
            --restart-policy Always \
            --location ${{ env.LOCATION }} \
            --registry-username ${{ secrets.ACR_USERNAME }} \
            --registry-password ${{ secrets.ACR_PASSWORD }} \
            --os-type Linux
          
          # Get third canary IP
          CANARY3_IP=$(az container show \
            --resource-group ${{ env.RESOURCE_GROUP }} \
            --name bp-canary-phase3 \
            --query "ipAddress.ip" -o tsv)
          echo "CANARY3_IP=$CANARY3_IP" >> $GITHUB_OUTPUT

      - name: Monitor Canary Phase 3 (75% Traffic Simulation)
        run: |
          echo "üìä Monitoring Canary Phase 3 (${{ env.CANARY_PHASE_3 }}% traffic simulation)"
          echo "Duration: 240 seconds"
          
          CANARY1_IP=${{ steps.deploy-canary-phase1.outputs.CANARY_IP }}
          CANARY2_IP=${{ steps.deploy-canary-phase2.outputs.CANARY2_IP }}
          CANARY3_IP=${{ steps.deploy-canary-phase3.outputs.CANARY3_IP }}
          
          # Simulate 75% traffic to canary instances
          for i in {1..24}; do
            echo "Interval $i/24 (10 seconds each)..."
            
            # Traffic pattern: 75% to canaries, 25% to production
            if [ "${{ steps.check-existing.outputs.EXISTING_PRODUCTION }}" = "true" ]; then
              curl -s http://${{ steps.check-existing.outputs.EXISTING_IP }}:8080/health > /dev/null || true
            fi
            
            # 75% to canaries (3 requests to canary for every 1 to production)
            curl -s http://$CANARY1_IP:8080/health > /dev/null || true
            curl -s http://$CANARY2_IP:8080/health > /dev/null || true
            curl -s http://$CANARY3_IP:8080/health > /dev/null || true
            
            # Comprehensive test every 4th interval
            if [ $((i % 4)) -eq 0 ]; then
              echo "  üß™ Comprehensive functionality test..."
              for canary_ip in $CANARY1_IP $CANARY2_IP $CANARY3_IP; do
                curl -s -X POST http://$canary_ip:8080/api/bp/calculate \
                  -H "Content-Type: application/json" \
                  -d '{"Systolic":140,"Diastolic":90}' > /dev/null && \
                  echo "    Canary at $canary_ip: OK" || true
              done
            fi
            
            sleep 10
          done

      # =====================
      # FINAL PHASE: Replace production with new version
      # =====================
      - name: Deploy Final Production Version
        id: deploy-final-production
        run: |
          echo "üéØ FINAL PHASE: Deploying new production version"
          echo "Traffic: 100% to new version"
          
          # Deploy new production container
          az container create \
            --resource-group ${{ env.RESOURCE_GROUP }} \
            --name bp-production-new \
            --image ${{ env.ACR_NAME }}.azurecr.io/${{ env.IMAGE_NAME }}:latest \
            --cpu 1 \
            --memory 1.5 \
            --ports 8080 \
            --dns-name-label bp-production-${{ github.run_id }} \
            --environment-variables ASPNETCORE_ENVIRONMENT=Production \
            --restart-policy Always \
            --location ${{ env.LOCATION }} \
            --registry-username ${{ secrets.ACR_USERNAME }} \
            --registry-password ${{ secrets.ACR_PASSWORD }} \
            --os-type Linux
          
          # Get new production IP
          NEW_PROD_IP=$(az container show \
            --resource-group ${{ env.RESOURCE_GROUP }} \
            --name bp-production-new \
            --query "ipAddress.ip" -o tsv)
          echo "NEW_PROD_IP=$NEW_PROD_IP" >> $GITHUB_OUTPUT
          
          # Verify new production is healthy
          echo "Verifying new production health..."
          for i in {1..10}; do
            if curl -s -f http://$NEW_PROD_IP:8080/health > /dev/null; then
              echo "‚úÖ New production is healthy!"
              break
            fi
            echo "‚è≥ Waiting for new production... Attempt $i/10"
            sleep 3
          done

      - name: Cleanup Old Resources
        if: always()
        run: |
          echo "üßπ Cleaning up old resources..."
          
          # Delete old production container if it exists
          if [ "${{ steps.check-existing.outputs.EXISTING_PRODUCTION }}" = "true" ]; then
            echo "Deleting old production container..."
            az container delete \
              --resource-group ${{ env.RESOURCE_GROUP }} \
              --name bp-production \
              --yes || true
          fi
          
          # Delete all canary containers
          echo "Deleting canary containers..."
          for container in bp-canary-phase1 bp-canary-phase2 bp-canary-phase3; do
            az container delete \
              --resource-group ${{ env.RESOURCE_GROUP }} \
              --name $container \
              --yes || true
            echo "  Deleted: $container"
          done
          
          # Rename new production to standard name
          echo "Renaming new production to 'bp-production'..."
          az container delete \
            --resource-group ${{ env.RESOURCE_GROUP }} \
            --name bp-production-new \
            --yes || true
          
          # Recreate with standard name (ACI doesn't support rename, so recreate)
          az container create \
            --resource-group ${{ env.RESOURCE_GROUP }} \
            --name bp-production \
            --image ${{ env.ACR_NAME }}.azurecr.io/${{ env.IMAGE_NAME }}:latest \
            --cpu 1 \
            --memory 1.5 \
            --ports 8080 \
            --dns-name-label bp-production-final-${{ github.run_id }} \
            --environment-variables ASPNETCORE_ENVIRONMENT=Production \
            --restart-policy Always \
            --location ${{ env.LOCATION }} \
            --registry-username ${{ secrets.ACR_USERNAME }} \
            --registry-password ${{ secrets.ACR_PASSWORD }} \
            --os-type Linux
          
          echo "‚úÖ Cleanup complete!"

  # =====================
  # DEPLOYMENT SUMMARY
  # =====================
  deployment-summary:
    runs-on: ubuntu-latest
    needs: azure-canary-deployment
    if: always()
    steps:
      - name: Azure Login
        uses: azure/login@v2
        with:
          client-id: ${{ secrets.AZURE_CLIENT_ID }}
          tenant-id: ${{ secrets.AZURE_TENANT_ID }}
          subscription-id: ${{ secrets.AZURE_SUBSCRIPTION_ID }}

      - name: Generate Deployment Report
        run: |
          echo "# üöÄ Azure Canary Deployment Complete!"
          echo "## üìã Deployment Details"
          echo "- **Application**: BP Calculator"
          echo "- **Resource Group**: ${{ env.RESOURCE_GROUP }}"
          echo "- **Region**: ${{ env.LOCATION }}"
          echo "- **Deployment Strategy**: Progressive Canary Release"
          echo "- **Traffic Progression**: ${{ env.CANARY_PHASE_1 }}% ‚Üí ${{ env.CANARY_PHASE_2 }}% ‚Üí ${{ env.CANARY_PHASE_3 }}% ‚Üí 100%"
          echo "- **Total Monitoring Time**: 540 seconds (9 minutes)"
          echo ""
          echo "## ‚úÖ Azure Resources Status"
          
          # List all containers in the resource group
          echo "Active Containers:"
          az container list \
            --resource-group ${{ env.RESOURCE_GROUP }} \
            --query "[].{Name:name, Status:provisioningState, IP:ipAddress.ip, Image:image}" \
            -o table
          
          echo ""
          echo "## üîó Access Information"
          PROD_INFO=$(az container show \
            --resource-group ${{ env.RESOURCE_GROUP }} \
            --name bp-production \
            --query "{IP:ipAddress.ip, FQDN:ipAddress.fqdn}" -o json)
          
          PROD_IP=$(echo $PROD_INFO | jq -r '.IP')
          PROD_FQDN=$(echo $PROD_INFO | jq -r '.FQDN')
          
          echo "- **Production IP**: $PROD_IP"
          echo "- **Production FQDN**: $PROD_FQDN"
          echo "- **Health Check**: http://$PROD_IP:8080/health"
          echo "- **API Endpoint**: http://$PROD_IP:8080/api/bp/calculate"
          echo ""
          echo "## üéØ Test Your Deployment"
          echo "Run these commands to verify:"
          echo '```bash'
          echo "# Health check"
          echo "curl http://$PROD_IP:8080/health"
          echo ""
          echo "# Test BP calculation"
          echo 'curl -X POST http://'$PROD_IP':8080/api/bp/calculate \'
          echo '  -H "Content-Type: application/json" \'
          echo '  -d '\''{"Systolic":120,"Diastolic":80}'\'''
          echo '```'
          echo ""
          echo "## üí° Next Steps"
          echo "1. Configure custom domain (if needed)"
          echo "2. Set up Azure Monitor alerts"
          echo "3. Configure auto-scaling based on traffic"
          echo "4. Set up backup policies"
